{% extends 'base.html' %}
{% block content %}
    <div id="vue-app">
        <div class="card">
            <div class="card-header text-center">
                <h2 class="card-text">App de Venda</h2>
            </div>
            <div class="card-body">
                <div class="alert-warning" v-if="errors">

                </div>
                <form @submit.prevent="add_produto" name="produtos_comprados">
                    <div class="col-sm-12 padding-off">
                        <div class="row">
                            <div class="col-sm-7">
                                <div class="form-group-inline">
                                    <label class="sr-only" for="Produto"></label>
                                    <input type="text" id="Produto" name="produto_ean"
                                           class="form-control" placeholder="Digite o EAN do produto"
                                           v-model="produto_ean"/>
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="form-group-inline">
                                    <label class="sr-only" for="quantidade"></label>
                                    <input type="text" id="quantidade" name="newDomain"
                                           class="form-control" v-model="quantidade"/>
                                </div>
                            </div>
                            <div class="col-sm-2 padding-off">
                                <div class="form-group">
                                    <button type="submit" class="btn btn-outline-success btn-block">
                                        <i aria-hidden="true" class="fa fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                        </div>

                    </div>
                </form>

                <div class="col-sm-12 mt-15 pt-5">
                    <template v-if="produtos.length">
                        <div class="card-header text-center">

                            <h2>Lista de produtos selecionados:</h2>
                        </div>
                        <table class="table table-responsive-lg">
                            <thead class="thead-active text-muted">
                            <tr>
                                <th scope="col">Produtos</th>
                                <th scope="col">Categoria</th>
                                <th scope="col">Subcategoria</th>
                                <th scope="col">Tamanho</th>
                                <th scope="col">Quantidade</th>
                                <th scope="col">Cor</th>
                                <th scope="col">Genero</th>
                                <th scope="col">Codigo de Barras</th>
                                <th scope="col">Em estoque</th>
                                <th scope="col">Remover</th>
                            </tr>
                            </thead>
                            <tbody>
                            <template v-for="produto in produtos">
                                <tr>
                                    <td>[[ produto.produto.descricao ]]</td>
                                    <td>[[ produto.produto.nome_categoria ]]</td>
                                    <td>[[ produto.produto.nome_subcategoria ]]</td>
                                    <td>[[ produto.produto.tamanho ]]</td>
                                    <td>[[ produto.quantidade ]]</td>
                                    <td>[[ produto.produto.cor ]]</td>
                                    <td>[[ produto.produto.genero.toUpperCase() ]]</td>
                                    <td>[[ produto.produto.ean ]]</td>
                                    <td>[[ produto.produto.total_pecas ]]</td>
                                    <td>
                                        <button
                                                @click="remove_produto(produto)"
                                                class="btn btn-sm btn-danger">
                                            <i aria-hidden="true" class="fa fa-times"></i>
                                        </button>
                                    </td>
                                </tr>

                            </template>
                            </tbody>
                        </table>
                    </template>

                </div>

            </div>
            <div class="card-blockquote">
                <h3 style="position: absolute; right: 4em">Valor total da venda: R$ [[ valor_total ]]</h3>
            </div>
        </div>
    </div>

{% endblock %}
{% block extrajs %}
    <script type="text/javascript">
        let app = new Vue({
            el: "#vue-app",
            delimiters: ['[[', ']]'],
            data: {
                produto_ean: '',
                quantidade: 1,
                produtos: [],
                valor_total: 0.00,
                errors: '',
                http: "{% url 'api_http' %}"
            },
            methods: {
                add_produto() {
                    if (this.produto_ean === "") {
                        this.errors = "NÃ£o encontrado"
                        console.log(this.errors)
                    } else {
                        axios.get(this.http + "produto/" + this.produto_ean)
                            .then(response => {
                                if (response.status === 200) {
                                    this.produtos.push(
                                        {
                                            'produto': response.data,
                                            "quantidade": this.quantidade
                                        }
                                    )

                                    this.valor_total += Number(response.data.preco_venda)
                                    console.log(response)
                                    console.log(this.produto_ean)
                                }
                            })
                            .catch(error => {
                                if (error.response) {
                                    console.log(error.response.status);
                                }
                                if (error === 404) {
                                    //this.errors = response.data
                                    console.log(this.errors)
                                }
                                console.log(error);
                            })
                    }
                },
                remove_produto(produto) {
                    this.produtos.splice(this.produtos.indexOf(produto), 1)
                },
                realiza_venda() {
                    axios.post("{% url 'produto' %}", {"produto": this.produto, "quantidade": this.quantidade})
                        .then(response => {
                            if (response.status === 200) {
                                location.reload()
                            }
                        })
                        .catch(error => {
                            console.log(error);
                        })
                }
            }
        })

        /*mounted() {
                    axios.get(this.http + 'produtos/')
                        .then(response => {
                            if (response.status === 200) {
                                (console.log(response.data)
                                )
                            }
                        })
                        .catch(error => {
                            if (error.status === 404){
                                this.errors = response.data
                                console.log(this.errors)
                            }
                            console.log(error)
                        })
                },*/
    </script>
{% endblock %}